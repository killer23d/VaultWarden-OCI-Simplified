[Definition]
#
# Action: cloudflare-bearer.conf
#
# Blocks/unblocks IPs at Cloudflare using a scoped API token (Bearer token).
# This is the modern, recommended method.
#
actionban = curl -s -X POST "https://api.cloudflare.com/client/v4/zones/<cfzone>/firewall/access_rules/rules" \
            -H "Authorization: Bearer <cftoken>" \
            -H "Content-Type: application/json" \
            --data '{"mode":"block","configuration":{"target":"ip","value":"<ip>"},"notes":"Fail2Ban ban for <name> from <ip>"}'

actionunban = id=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/<cfzone>/firewall/access_rules/rules?mode=block&configuration.target=ip&configuration.value=<ip>&page=1&per_page=1" \
              -H "Authorization: Bearer <cftoken>" \
              -H "Content-Type: application/json" \
              | jq -r '.result[0].id // empty'); \
              if [ -n "$id" ]; then \
                curl -s -X DELETE "https://api.cloudflare.com/client/v4/zones/<cfzone>/firewall/access_rules/rules/$id" \
                -H "Authorization: Bearer <cftoken>" \
                -H "Content-Type: application/json"; \
              fi

[Init]
# These values will be populated from settings.json during setup.
# Create a scoped Cloudflare API Token with permissions:
# Zone:Zone:Read and Zone:Firewall Services:Edit
cfzone = {{CLOUDFLARE_ZONE_ID}}
cftoken = {{CLOUDFLARE_API_TOKEN}}
